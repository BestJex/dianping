# 门店推荐
实现原理，通过SQL数学公式进行计算得出两点之间距离。

## 怎么用经纬度计算两地之间的距离？ 

1、地球赤道上环绕地球一周走一圈共40075.04公里,而@一圈分成360°,而每1°(度)有60,每一度一秒在赤道上的长度计算如下：    

`40075.04km/360°=111.31955km`    
`111.31955km/60=1.8553258km=1855.3m`
  
而每一分又有60秒,每一秒就代表1855.3m/60=30.92m    
任意两点距离计算公式为`d＝111.12cos{1/[sinΦAsinΦB十cosΦAcosΦBcos(λB—λA)]}`
其中A点经度，纬度分别为λA和ΦA，B点的经度、纬度分别为λB和ΦB，d为距离。 

2、分为3步计算：  
### 第1步 分别将两点经纬度转换为三维直角坐标：

假设地球球心为三维直角坐标系的原点，球心与赤道上0经度点的连线为X轴，球心与赤道上东经90度点的连线为Y轴，球心与北极点的连线为Z轴，则地面上点的直角坐标与其经纬度的关系为：  x=R×cosα×cosβ  y=R×cosα×sinβ  z=R×sinα  
R为地球半径，约等于6400km；  α为纬度，北纬取+，南纬取-；  β为经度，东经取+，西经取-。  

### 第2步 根据直角坐标求两点间的直线距离（即弦长）：
  
如果两点的直角坐标分别为(x1,y1,z1)和(x2,y2,z2)，则它们之间的直线距离为：  L=[(x1-x2)^2+(y1-y2)^2+(z1-z2)^2]^0.5  上式为三维勾股定理，L为直线距离。  

### 第3步 根据弦长求两点间的距离（即弧长）：  
由平面几何知识可知弧长与弦长的关系为：  S=R×π×2[arc sin(0.5L/R)]/180  
上式中角的单位为度，1度＝π/180弧度，S为弧长。
 
3、1度的实际长度是111公里。但纬线的距离会越考两端越小，他的距离就会变成111乘COS纬度数，经度不变。
 
4、南北方向算出两点纬度差,一度等于60海里,1分等于1海里,海里与公里换算关系1海里等于1.852公里。东西方向量出距离到两点间纬度附近量出纬度差，得出海里数，再乘以1.852换算成公里。可按直角三角形原理求出两点间距离。
 
5、度的实际长度是111公里。但纬线的距离会越考两端越小，他的距离就会变成111乘COS纬度数，经度不变(如果在同一经度) 


## 数据库计算距离:
 ```sql
ceil(1 + 1000*(2 * 6378.137* ASIN(SQRT(POW(SIN(PI() * (#{latitude} - latitude) / 360), 2) + COS(PI() * #{latitude} / 180)
        * COS(latitude* PI() / 180) * POW(SIN(PI() * (#{longitude} - longitude) / 360), 2))))) AS distance
 ```

2、将距离和评分进行归一化处理
```sql
(0.95*1/log10(distance)+ 0.05*remark_score/5)
```

3、推荐SQL全览
```xml
<!-- 推荐 推荐 距离因子95%受地理 评分因子5%收评分影响  -->
<select id="recommend" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    ,ceil(1 + 1000*(2 * 6378.137* ASIN(SQRT(POW(SIN(PI() * (#{latitude} - latitude) / 360), 2) + COS(PI() * #{latitude} / 180)
    * COS(latitude* PI() / 180) * POW(SIN(PI() * (#{longitude} - longitude) / 360), 2))))) AS distance
    from shop order by (0.95*1/log10(distance)+ 0.05*remark_score/5)  DESC
</select>
```